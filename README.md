# Используйте на свой страх и риск, никаких гарантий не даю.

# Что нужно:
1. Домашний роутер на Linux с жёстким диском или сервер на Linux с wget и curl;
2. Камера Yi 4k+ с прошивкой 1.4.14 (возможно будет работать на других)

# Порядок установки:
1. [Настроить](https://github.com/irungentoo/Xiaomi_Yi_4k_Camera/tree/master/telnet) доступ к камере по telnet;
2. [Настроить](https://github.com/irungentoo/Xiaomi_Yi_4k_Camera/tree/master/4k%2B/wifi) режим wifi, чтобы камера цеплялась к домашнему роутеру;
3. На роутере зафиксировать ip адрес для MAC камеры (в настройках DHCP), чтобы адрес не менялся со временем;
4. На камере отключить режим автовыключения по истечению времени;
5. Положить в корень карты памяти [ftp.sh](https://github.com/ffonord/yi4kplus-video-export/blob/master/ftp.sh), чтобы запускать ftp сервер;
6. Скачать [video_export.sh](https://github.com/ffonord/yi4kplus-video-export/blob/master/video_export.sh) на роутер или домашний сервер и [добавить задачу](https://docs.oracle.com/cd/E19253-01/817-0403/sysrescron-72169/index.html) для запуска в crontab;
```
* * * * * /usr/bin/flock -n /tmp/video_export.lockfile /home/user/video_export.sh
```
7. При необходимости поправить переменные в начале скрипта:
   - `cameraIp` - адрес камеры в домашней сети;
   - `ftpWorkTime` - время работы сервера в секундах (можно оставить без изменений);
   - `ftpPath` - директория на камере (можно оставить без изменений если совпадает);
   - `baseDir` - полный путь сохранения видео (будут создаваться подкаталоги с датой выгрузки, например `2023-06-03`)

Не использую стандартную настройку wifi камеры потому что скорость загрузки в 2 раза ниже в таком режиме.
Не использую выгрузку по http, через стандартный web сервер камеры потому что она часто виснет в таком режиме работы (по крайней мере у меня).

# Описание работы
1. Добавленный в crontab скрипт "ждёт" когда камера появится в локальной сети;
2. Включённая камера в домашней зоне wifi подключится к роутеру. Камеру нужно выключить -> включить если вы пришли с улицы, подключение к роутеру происходит только в момент включения;
3. Скрипт запускает [ftp.sh](https://github.com/ffonord/yi4kplus-video-export/blob/master/ftp.sh) на камере через telnet, создаёт директорию выгрузки с сегодняшней датой;
4. Качает файл, проверяет размер, если файл получен полностью, то удаляет файлы с камеры;
5. Если в директории сервера скрипт обнаружит недокаченный файл, он будет удалён (предполагается что скачается при следущем включении камеры дома);

# TODO:
- выключение камеры после выгрузки всех файлов (слёту не получилось найти способ её отключить через telnet);
- настройка ротации файлов, чтобы при заполненнии места на диске (сервера) освобождалось место удалением старых файлов в `baseDir`.